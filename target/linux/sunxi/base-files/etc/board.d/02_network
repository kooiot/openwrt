#!/bin/sh
#
# Copyright (C) 2013-2015 OpenWrt.org
#

. /lib/functions/uci-defaults.sh
. /lib/functions/system.sh

# This is not used so far, as we hacks MAC
tlink_setup_macs()
{
	local lan_mac=""
	local wan_mac=""

	NVMEM_PATH="/sys/bus/i2c/devices/0-0050/eeprom"
	if [ ! -f ${NVMEM_PATH} ]; then
		NVMEM_PATH="/sys/bus/i2c/devices/0-0050/0-00501/nvmem"
	fi
	if [ -f ${NVMEM_PATH} ]; then
		lan_mac=$(get_mac_binary "/sys/bus/i2c/devices/0-0050/eeprom" 0x20)
		wan_mac=$(macaddr_add $(get_mac_binary "/sys/bus/i2c/devices/0-0050/eeprom" 0x20) 1)
	else
		lan_mac=$(get_mac_binary "/dev/mmcblk1" 0x64220)
		wan_mac=$(macaddr_add $(get_mac_binary "/dev/mmcblk1" 0x64220) 1)
	fi

	[ -n "$lan_mac" ] && ucidef_set_interface_macaddr "lan" $lan_mac
	[ -n "$wan_mac" ] && ucidef_set_interface_macaddr "wan" $wan_mac
}

tlink_setup_interface_mac()
{
	local ifname=$1
	local offset=$2
	local lan_mac

	. /lib/functions/tlink.sh

	lan_mac=$(tlink_gen_mac_emmc_serial $offset)

	# [ -n "$lan_mac" ] && echo "$lan_mac" > /dev/console
	[ -n "$lan_mac" ] && ucidef_set_interface_macaddr "$ifname" "$lan_mac"
}

board_config_update

case $(board_name) in
friendlyarm,nanopi-r1)
	ucidef_set_interfaces_lan_wan "eth1" "eth0"
	;;
lamobo,lamobo-r1)
	ucidef_add_switch "switch0" \
		"4:lan:1" "0:lan:2" "1:lan:3" "2:lan:4" "3:wan" "8@eth0"
	;;
olimex,a20-olinuxino-micro)
	ucidef_set_interface_lan "wlan0"
	;;
xunlong,orangepi-r1)
	ucidef_set_interfaces_lan_wan "eth0" "eth1"
	;;
kooiot,tlink-x3)
#	tlink_setup_macs
	ucidef_set_interfaces_lan_wan "eth0" "eth1"
	;;
kooiot,tlink-x1|\
kooiot,tlink-x1s|\
kooiot,tlink-x2|\
kooiot,tlink-k2x|\
kooiot,tlink-r1)
	ucidef_set_interfaces_lan_wan "eth0" "eth1"
	;;
kooiot,tlink-k2x-1)
	ucidef_set_interface_lan "eth0"
	ucidef_set_interface "lan2" device "eth1" protocol "static"
	;;
kooiot,tlink-k1)
	ucidef_set_interface_lan "eth0 eth1"
	;;
kooiot,tlink-k2|\
kooiot,tlink-m408|\
kooiot,tlink-m416)
#	tlink_setup_macs
	ucidef_set_interface_lan "eth0"
	ucidef_set_interface "lan2" device "eth1" protocol "static"
	ucidef_set_interface "lan3" device "eth2" protocol "static"
	ucidef_set_interface "lan4" device "eth3" protocol "static"
	;;
kooiot,tlink-s1)
	ucidef_set_interface_lan "eth0"
	tlink_setup_interface_mac "lan" 0
	;;
*)
	ucidef_set_interface_lan "eth0"
	;;
esac

board_config_flush

exit 0
