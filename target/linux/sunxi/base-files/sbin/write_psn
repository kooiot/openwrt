#!/bin/sh

psn=$1

. /lib/functions.sh
. /lib/functions/tlink.sh

case "$(board_name)" in
"sipeed,lichee-zero-plus" | \
"kooiot,tlink-x1" | \
"kooiot,tlink-x1s" | \
"kooiot,tlink-x3" | \
"kooiot,tlink-k1" | \
"kooiot,tlink-s1" | \
"kooiot,tlink-ok-a40i" | \
"kooiot,tlink-dj-a40i-e" | \
"kooiot,tlink-dr4-a40i" | \
"kooiot,tlink-nano-a40i" | \
"kooiot,tlink-qh-x40" | \
"kooiot,tlink-m408" | \
"kooiot,tlink-m416" | \
"kooiot,tlink-r1")
	;;
*)
	echo "This only support ThingsLink devices"
	exit 1
	;;
esac

show_help(){
    cat <<EOF
${0} <psn>
EOF
}

if [ $# -eq 0 ]; then
	show_help()
	exit 1
fi

if [ -f /lib/functions/psn/parser.sh ] ; then
	. /lib/functions/psn/parser.sh
	echo "PSN SRC: ${psn}"

	psn="$(product_sn_encode ${psn})"
	if [ ${#psn} -le 8 ]; then
		echo "Product Serial Number encode failed!"
		exit 3
	fi
fi

if [ ${#psn} -ne 16 ]; then
	echo "Product Serial Number must be 16 characters!"
	exit 2
fi

echo "PSN: ${psn}"
#----------------------------------------------------------
echo ""
echo -n "WARNING: PRODUCT SERIAL NUMBER REPLACED !, Continue (y/N)?  "
read -n 1 ANSWER

if [ ! "${ANSWER}" = "y" ] ; then
    echo "."
    echo "Canceled.."
    exit 0
fi
echo ""
#----------------------------------------------------------


NVMEM_PATH="/sys/bus/i2c/devices/0-0050/eeprom"
if [ ! -f ${NVMEM_PATH} ]; then
	NVMEM_PATH="/sys/bus/i2c/devices/0-0050/0-00501/nvmem"
fi

if [ ! -f ${NVMEM_PATH} ]; then
    echo "EEPROM not found! Product SN will be writen to EMMC!!!"

	echo ${psn} | dd of=/dev/mmcblk1 count=16 bs=1 seek=410112
	echo ${psn} | dd of=/dev/mmcblk1 count=16 bs=1 seek=410128

	product_sn=$(dd if=/dev/mmcblk1 \
		bs=1 count=16 skip=410112 2>/dev/null | \
		hexdump -v -e '/1 "%c"' 2>/dev/null)

	product_sn_dp=$(dd if=/dev/mmcblk1 \
		bs=1 count=16 skip=410128 2>/dev/null | \
		hexdump -v -e '/1 "%c"' 2>/dev/null)
else
	echo ${psn} | dd of=${NVMEM_PATH} count=16 bs=1 seek=0
	echo ${psn} | dd of=${NVMEM_PATH} count=16 bs=1 seek=16

	product_sn=$(dd if=${NVMEM_PATH} \
		bs=1 count=16 skip=0 2>/dev/null | \
		hexdump -v -e '/1 "%c"' 2>/dev/null)

	product_sn_dp=$(dd if=${NVMEM_PATH} \
		bs=1 count=16 skip=16 2>/dev/null | \
		hexdump -v -e '/1 "%c"' 2>/dev/null)
fi

if [ "${product_sn}"x = "${product_sn_dp}"x ]; then
	echo "${product_sn}" > /tmp/sysinfo/product_sn
	echo "Loaded PSN: ${product_sn}"

	echo "Done!"

	exit 0
else
	echo "Write failed!!!!"
	exit 1
fi

exit 99
