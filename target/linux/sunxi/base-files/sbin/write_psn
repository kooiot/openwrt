#!/bin/sh

psn=$1

. /lib/functions.sh
. /lib/functions/tlink.sh

case "$(board_name)" in
"kooiot,tlink-x1" | \
"kooiot,tlink-x2" | \
"kooiot,tlink-k1" | \
"kooiot,tlink-r1")
	;;
*)
	echo "This only support ThingsLink devices"
	exit 1
	;;
esac

show_help(){
    cat <<EOF
${0} <psn>
EOF
}

if [ $# -eq 0 ]; then
	show_help()
	exit 1
fi

if [ ${#psn} -ne 16 ]; then
	echo "Product Serial Number must be 16 characters"
	exit 2
fi

echo "PSN: ${psn}"
#----------------------------------------------------------
echo ""
echo -n "WARNING: PRODUCT SERIAL NUMBER REPLACED !, Continue (y/N)?  "
read -n 1 ANSWER

if [ ! "${ANSWER}" = "y" ] ; then
    echo "."
    echo "Canceled.."
    exit 0
fi
echo ""
#----------------------------------------------------------


NVMEM_PATH="/sys/devices/platform/soc/1c2ac00.i2c/i2c-0/0-0050/0-00500/nvmem"

if [ ! -f ${NVMEM_PATH} ]; then
    echo "EEPROM not found! Product SN will be writen to EMMC!!!"

	echo ${psn} | dd of=/dev/mmcblk1 count=16 bs=1 seek=410112
	echo ${psn} | dd of=/dev/mmcblk1 count=16 bs=1 seek=410128

	product_sn=$(dd if=/dev/mmcblk1 \
		bs=1 count=16 skip=410112 2>/dev/null | \
		hexdump -v -e '/1 "%c"' 2>/dev/null)

	product_sn_dp=$(dd if=/dev/mmcblk1 \
		bs=1 count=16 skip=410128 2>/dev/null | \
		hexdump -v -e '/1 "%c"' 2>/dev/null)
else
	echo ${psn} | dd of=${NVMEM_PATH} count=16 bs=1 seek=0
	echo ${psn} | dd of=${NVMEM_PATH} count=16 bs=1 seek=16

	product_sn=$(dd if=${NVMEM_PATH} \
		bs=1 count=16 skip=0 2>/dev/null | \
		hexdump -v -e '/1 "%c"' 2>/dev/null)

	product_sn_dp=$(dd if=${NVMEM_PATH} \
		bs=1 count=16 skip=16 2>/dev/null | \
		hexdump -v -e '/1 "%c"' 2>/dev/null)
fi

if [ "${product_sn}"x = "${product_sn_dp}"x ]; then
	echo "Loaded PSN: ${product_sn}"

	echo "Done!"

	exit 0
else
	echo "Write failed!!!!"
	exit 1
fi

exit 99
